<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhập điểm môn học</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .container {
          margin-top: 30px;
        }

        .add-button {
          cursor: pointer;
          color: blue;
        }
    </style>
</head>

<body>
<div class="container">
    <h2 class="text-center text-primary">NHẬP ĐIỂM MÔN HỌC</h2>

    <form method="GET" action="/input_scores">
        <div class="row mb-3">
            <div class="col">
                <label for="class" class="form-label">Lớp:</label>
                <select id="class" name="class_id" class="form-select">
                    <option value="">Chọn lớp</option>
                    {% for class in classes %}
                    <option value="{{ class.id }}" {% if class.id== class_id|int %} selected {% endif %}>{{ class.name
                        }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label for="semester" class="form-label">Học kỳ:</label>
                <select id="semester" name="semester_id" class="form-select">
                    <option value="">Chọn học kỳ</option>
                    {% for semester in semesters %}
                    <option value="{{ semester.id }}" {% if semester.id== semester_id|int %} selected {% endif %}>{{
                        semester.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label for="subject" class="form-label">Môn học:</label>
                <select id="subject" name="subject_id" class="form-select">
                    <option value="">Chọn môn học</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}" {% if subject.id== subject_id|int %} selected {% endif %}>{{
                        subject.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label for="year" class="form-label">Năm học:</label>
                <select id="year" name="year_id" class="form-select">
                    <option value="">Chọn năm học</option>
                    {% for year in years %}
                    <option value="{{ year.id }}" {% if year.id== year_id|int %} selected {% endif %}>{{ year.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Tìm kiếm</button>
    </form>

    {% if students %}
    <form method="POST" action="/input_scores">
        <input type="hidden" name="class_id" value="{{ class_id }}">
        <input type="hidden" name="semester_id" value="{{ semester_id }}">
        <input type="hidden" name="subject_id" value="{{ subject_id }}">
        <input type="hidden" name="year_id" value="{{ year_id }}">


        <table class="table mt-4">
            <thead>
            <tr>
                <th scope="col">Tên sinh viên</th>
                <th scope="col">Điểm 15 phút</th>
                <th scope="col">Điểm 1 tiết</th>
                <th scope="col">Điểm thi cuối kỳ</th>
                <th scope="col">Điểm trung bình</th>
            </tr>
            </thead>
            <tbody>
            {% for student in students %}
            <tr>
                <td>{{ student.name }}</td>

                <td>
                    <div id="score_15_min_{{ student.id }}">
                        {% set scores_15_min = scores.get(student.id|string, {}).get('score_15_min', []) %}
                        {% for score in scores_15_min %}
                        <input type="number" name="score_15_min_{{ student.id }}[]" class="form-control score_15_min"
                               value="{{ score }}">
                        {% endfor %}
                        {% if not scores_15_min %}
                        <input type="number" name="score_15_min_{{ student.id }}[]" class="form-control score_15_min"
                               value="0">
                        {% endif %}
                    </div>
                    <button type="button" class="add-button" onclick="addScoreColumn('15_min', {{ student.id }})">+
                    </button>
                    <button type="button" class="remove-button" onclick="removeScoreColumn('15_min', {{ student.id }})">
                        -
                    </button>
                </td>

                <td>
                    <div id="score_1_hour_{{ student.id }}">
                        {% set scores_1_hour = scores.get(student.id|string, {}).get('score_1_hour', []) %}
                        {% for score in scores_1_hour %}
                        <input type="number" name="score_1_hour_{{ student.id }}[]" class="form-control score_1_hour"
                               value="{{ score }}" oninput="calculateAverage({{ student.id }})">
                        {% endfor %}
                        {% if not scores_1_hour %}
                        <input type="number" name="score_1_hour_{{ student.id }}[]" class="form-control score_1_hour"
                               value="0" oninput="calculateAverage({{ student.id }})">
                        {% endif %}
                    </div>
                    <button type="button" class="add-button" onclick="addScoreColumn('1_hour', {{ student.id }})">+
                    </button>
                    <button type="button" class="remove-button" onclick="removeScoreColumn('1_hour', {{ student.id }})">
                        -
                    </button>
                </td>

                <td>
                    <input type="number" name="final_exam_{{ student.id }}" class="form-control final_exam"
                           value="{{ scores.get(student.id|string, {}).get('final_exam', 0) }}"
                           oninput="calculateAverage({{ student.id }})">
                </td>

                <td>
                    <input type="text" id="average_score_{{ student.id }}" class="form-control"
                           value="{{ average_scores.get(student.id, 0) }}" readonly>
                    <input type="hidden" name="average_score_{{ student.id }}" class="form-control">
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-success">Lưu điểm</button>
    </form>
    {% else %}
    <p class="text-center">Không có sinh viên nào phù hợp với tiêu chí tìm kiếm.</p>
    {% endif %}
</div>

<script>
    function addScoreColumn(scoreType, studentId) {
        const container = document.getElementById(`score_${scoreType}_${studentId}`);
        const inputs = container.querySelectorAll('input');

        if (scoreType === '15_min' && inputs.length >= 5) {
            alert("Tối đa 5 cột điểm 15 phút!");
            return;
        } else if (scoreType === '1_hour' && inputs.length >= 3) {
            alert("Tối đa 3 cột điểm 1 tiết!");
            return;
        }

        const newInput = document.createElement('input');
        newInput.type = 'number';
        newInput.name = `score_${scoreType}_${studentId}[]`;
        newInput.classList.add('form-control');
        newInput.classList.add(`score_${scoreType}`);
        newInput.oninput = function () {
            calculateAverage(studentId);
        };
        newInput.value = 0;
        container.appendChild(newInput);

        calculateAverage(studentId);
    }

    function removeScoreColumn(scoreType, studentId) {
        const container = document.getElementById(`score_${scoreType}_${studentId}`);
        const inputs = container.querySelectorAll('input');
        if (inputs.length > 1) {
            container.removeChild(inputs[inputs.length - 1]);
            calculateAverage(studentId);
        }
    }

    function calculateAverage(studentId) {
        const row = document.getElementById(`score_15_min_${studentId}`).closest('tr');

        const score15MinInputs = row.querySelectorAll('.score_15_min');
        let score15Min = 0;
        score15MinInputs.forEach(input => {
            score15Min += parseFloat(input.value) || 0;
        });

        const score1HourInputs = row.querySelectorAll('.score_1_hour');
        let score1Hour = 0;
        score1HourInputs.forEach(input => {
            score1Hour += parseFloat(input.value) || 0;
        });

        const finalExamInput = row.querySelector(`input[name="final_exam_${studentId}"]`);
        const finalExam = parseFloat(finalExamInput.value) || 0;

        const totalWeight = score15MinInputs.length * 1 + score1HourInputs.length * 2 + 3;
        let averageScore = (score15Min + score1Hour * 2 + finalExam * 3) / totalWeight;

        const averageScoreInput = document.getElementById(`average_score_${studentId}`);
        averageScoreInput.value = averageScore.toFixed(2);

        // Lấy input ẩn để lưu điểm trung bình
        const hiddenAverageInput = row.querySelector(`input[name="average_score_${studentId}"]`);
        if (hiddenAverageInput) {
            hiddenAverageInput.value = averageScore.toFixed(2);
        }
    }

    window.onload = function () {
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const studentId = row.querySelector('.score_15_min').name.match(/_(\d+)_/)[1];
            calculateAverage(studentId);
        });
    };
</script>

</body>
</html>
